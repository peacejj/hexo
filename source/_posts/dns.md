---
title: dns基于tcp还是udp
date: 2021-03-11 10:39:57
excerpt: dns基于tcp还是udp
tags: 
position:
image_url:
---

### **`DNS占用53号端口，同时使用TCP和UDP协议。`**

---

### 1、那么DNS在什么情况下使用这两种协议？
DNS在`区域传输`的时候使用TCP协议，其他时候使用UDP协议。

### 2、区域传送时使用TCP，主要有一下两点考虑： 
1. 辅域名服务器会定时（一般时3小时）向主域名服务器进行查询以便了解数据是否有变动。如有变动，则会执行一次区域传送，进行数据同步。区域传送将使用TCP而不是UDP，因为数据同步传送的数据量比一个请求和应答的数据量要多得多。 
2. TCP是一种可靠的连接，保证了数据的准确性。 

### 3、域名解析时使用UDP协议： 
客户端向DNS服务器查询域名，一般返回的内容都不超过512字节，用UDP传输即可。不用经过TCP三次握手，这样DNS服务器负载更低，响应更快。虽然从理论上说，客户端也可以指定向DNS服务器查询的时候使用TCP，但事实上，很多DNS服务器进行配置的时候，仅支持UDP查询包。

### 4、DNS请求流程
三种类型的 DNS 服务器，根 DNS 服务器，顶级域 DNS 服务器和权威 DNS 服务器。

浏览器本地—》系统本地host文件—》路由器缓存—》运营商DNS服务器-》

![image](/images/net/dns.png)
1. 首先浏览器会检查浏览器自身的DNS缓存中，是否有域名对应的DNS缓存(chrome缓存1分钟，大概有1000条缓存)，没有的话进入第二步，否则解析完成
1. 接下来去查看系统的hosts文件(C:\Windows\System32\drivers\etc)是否有域名对应的IP地址，如果找到则停止解析，否则进入第三步
1. 浏览器发起DNS系统调用，向本地配置的首选DNS服务器发起域名解析请求(通过UDP协议，向DNS的53端口发起请求)
1. 首先请求会在运营商的**DNS服务器(本地服务器)**上进行请求，如果找到对应的条目，且没有过期，则解析成功，否则进入第五步
1. 运营商的DNS服务器，根据解析请求，迭代查询，首先找到根域名服务器的IP地址(这个DNS服务器内置13台根域DNS的IP地址)，然后找到根域的DNS地址，发送请求
1. 根域服务器收到请求后，根据域名，返回对应的顶级域的服务器ip地址，并返回给运营商DNS服务器
1. 运营商DNS服务器接收到根域名服务器传回来的顶级域名服务器IP地址后，向顶级域名服务器发送请求
1. 顶级域名服务器接收到请求后，返回该域名对应的权威域名服务器的ip地址，并返回给运行商DNS服务器。
1. 运营商DNS服务器获得权威域名服务器的响应信息后，返回给请求的主机，DNS解析完成。
1. DNS主要是通过UDP通信，报文结构主要分为头部Header、查询部分Question、应答部分Answer/Authority/Addition。
